---
title: "vignette"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(rustcrn)
```

Make a map of the average temperature at each station for the month of March 2024.
```{r}
# get dataset of march 2024 data from each station
march_2024 <- subset(full_daily_weather, 
                  full_daily_weather$LST_DATE >= as.Date("2024-03-01") &
                           full_daily_weather$LST_DATE <= as.Date("2024-03-31"))


# calculate the mean average temperature from each station

average_march <- tapply(march_2024$T_DAILY_AVG, 
               march_2024$WBANNO, function(x) {mean(x, na.rm = T)} )

dat <- stations[match(as.numeric(names(average_march)), stations$WBANNO),] 
dat$mar_temp <- average_march

head(dat, 10)

#plot dat created

usa <- ggplot2::map_data("state")
par(bg = "grey90")
plot(NA, NA, xlim = c(min(usa$long), max(usa$long)), 
     ylim = c(min(usa$lat), max(usa$lat)), asp = 1.3, 
     axes = F, xlab = "", ylab = "", 
     main = "Average Temperature of Stations on March 2024")

invisible(tapply(usa, usa$group, function(x) polygon(x$long, x$lat,
                                   lwd = 0.5, border = "grey30", col = "white")))

points(dat$LONGITUDE, dat$LATITUDE, pch = 19, 
       col= heat.colors(length(dat$mar_temp))[rank(dat$mar_temp)], 
       cex = 1)



#legend created
lgd <- rep(NA, 50)
lgd[c(1, 25,50)] = c( min(dat$mar_temp),  median(dat$mar_temp), max(dat$mar_temp) )

# Create legend with dynamic color representation
legend(-75, 35, legend = lgd, 
       fill =   , 
       border = NA, y.intersp = 0.5, cex = 0.5, box.lwd = 0,
       title = "Temperature (°C) in March 2024\n", 
       xjust = 0)

#legend




```


Fit a spatial model and plot an interpolated map of average temperatures for March 2024. Consider including elevation in your model.
```{r}
dat_sf <- sf::st_as_sf(x = dat, coords = c("LONGITUDE", "LATITUDE"), 
                       crs = 4326, remove = TRUE)
elev <- elevatr::get_elev_point(dat_sf, src = "aws")
dat$elevation <- elev$elevation

grid_sf <- sf::st_as_sf(x = grid_points_usa(), coords = c("long", "lat"), 
                        crs = 4326)
elev.pred <- elevatr::get_elev_point(grid_sf, src = "aws")
elev.mat <- cbind(1, elev.pred$elevation)

mar_inter <- interpolation(mar_temp ~ LONGITUDE + LATITUDE + elevation, 
                           X_pred = elev.mat, 
                           data = dat)

plotting_interpolation(mar_inter, 
                       main = "Estimated average temperatures in March 2024", 
                       palette = "Temps")
```


Estimate the warmest and coldest day of the year for each station, and plot those days on two maps. Think carefully about how to represent the days numerically.
```{r}


station_id <- stations$WBANNO
st <- stations
# Initializing columns for data to be stored
st$min_doy <- NA
st$max_doy <- NA
st$min_temp <- NA
st$max_temp <- NA

# Loop through each station ID and calculate min and max temperatures and their dates
for (i in 1:length(station_id)) {
    year_data <- yearly_cycle(station_id[i])
    min_index <- which.min(year_data$t_daily_pred)
    max_index <- which.max(year_data$t_daily_pred)

    st$min_temp[i] <- year_data$t_daily_pred[min_index]
    st$max_temp[i] <- year_data$t_daily_pred[max_index]
    st$min_doy[i] <- year_data$doy[min_index]
    st$max_doy[i] <- year_data$doy[max_index]
}

head((st), 10)


# Warmest
par(bg = "grey90")
plot(NA, NA, xlim = c(min(usa$long), max(usa$long)), 
     ylim = c(min(usa$lat), max(usa$lat)), asp = 1.3, 
     axes = F, xlab = "", ylab = "", 
     main = "Estimated coldest day of the year \nat USCRN weather stations")

invisible(tapply(usa, usa$group, function(x) polygon(x$long, x$lat,
                                   lwd = 0.5, border = "grey30", col = "white")))
text(st$LONGITUDE, st$LATITUDE, st$max_doy, cex= 0.3)

# Coldest
par(bg = "grey90")
plot(NA, NA, xlim = c(min(usa$long), max(usa$long)), 
     ylim = c(min(usa$lat), max(usa$lat)), asp = 1.3, 
     axes = F, xlab = "", ylab = "", 
     main = "Estimated coldest day of the year \nat USCRN weather stations")

invisible(tapply(usa, usa$group, function(x) polygon(x$long, x$lat,
                                   lwd = 0.5, border = "grey30", col = "white")))
text(st$LONGITUDE, st$LATITUDE, st$min_doy, cex= 0.3)

```


Make a single plot of the estimated yearly cycles for 10 different
stations, highlighting a diversity of climates around the contiguous USA.
Your plot should clearly indicate which cycle is from which station.

```{r}
# Stations: Asheville, NC (53878); Ithaca, NY (64758); Boulder, CO (94075);
 #          Des Moines, ID (54902); Moose, WY (4131); Santa Barbara, CA (53152);
 #          Sioux Falls, SD (4990); Ajo, AZ (53168); Titusville, FL (92821);
 #          Austin, TX (23907)

selected <- c(53878, 64758, 94075, 54902, 4131, 53152, 4990, 53168, 92821, 23907)
cycles <- list()

for(i in 1:10) {
  cycles[[i]] <- yearly_cycle(selected[i])
}

plot(NULL, NULL, xlim = c(1,365), ylim = c(-25,35), axes = FALSE,
     ylab = "Estimated temperature (°C)", xlab = "")
axis.Date(1, format = "%B")
axis(2)
title(main = "USCRN weather station yearly cycles")
for(i in 1:10) {
  lines(cycles[[i]][,1], cycles[[i]][,2], col = i, lty = i)
}
legend(160, 3, legend = c("Asheville, NC", "Ithaca, NY", "Boulder, CO",
                         "Des Moines, ID", "Moose, WY", "Santa Barbara, CA",
                         "Sioux Falls, SD", "Ajo, AZ", "Titusville, FL",
                         "Austin, TX"),
       col = 1:10, lty = 1:10, cex = 0.5)
```


Estimate the trend over the years for each station, in units of degrees Fahrenheit per year, and plot the trend values on a map. Indicate visually on your map which of the trends are statistically significant.

```{r}
trends <- as.data.frame( cbind( WBANNO = stations$WBANNO,
                        matrix(nrow = nrow(stations),
                               ncol = 4,
                               dimnames = list(NULL, c("trend", "p", "se", "len"))),
                        LONGITUDE = stations$LONGITUDE,
                        LATITUDE = stations$LATITUDE ) )

for(i in 1:nrow(trends)) {
  trends[i,1:5] <- temp_trend(trends[i,1])
}

sig <- rep(FALSE, times = nrow(trends))
sig[trends$p < 0.001] <- TRUE

trends$sig <- sig
trends$color <- lapply(trends$trend, function(x) {
  if(x < 0) rgb(0, 0, abs(x)/(abs(x) + 0.01))
  else rgb(x/(x + 0.1), 0, 0)
})

hi_ak_sa <- which(stations$state %in% c("HI", "AK", "SA"))
plot_trends <- trends[-hi_ak_sa,]

usa <- ggplot2::map_data("state")

par(bg = "grey90")

plot(NA, NA, xlim = c(min(usa$long), max(usa$long)), 
     ylim = c(min(usa$lat), max(usa$lat)), asp = 1.3, 
     axes = F, xlab = "", ylab = "", 
     main = "Temperature trends at USCRN weather stations \nin the contiguous 48")

invisible(tapply(usa, usa$group, function(x) polygon(x$long, x$lat,
                                   lwd = 0.5, border = "grey30", col = "white")))

points(plot_trends$LONGITUDE[sig], plot_trends$LATITUDE[sig], 
       col = "orange", pch = 8, cex = 0.6)
points(plot_trends$LONGITUDE, plot_trends$LATITUDE,
     col = as.character(plot_trends$color), pch = 16,  cex = 0.5)


lgd <- rep(NA, 11)
lgd[c(1,6,11)] = c(1,0,-1)
legend(-75, 35, legend = lgd, 
       fill = colorRampPalette(colors = c('red','black','blue'))(11),
       border = NA, y.intersp = 0.5, cex = 0.5, box.lwd = 0,
       title = "°C/year \n", 
       xjust = 0)

legend(-120, 31, 
       legend = c("p < 0.001"), col = "orange", pch = 8, 
       title = "Significance", 
       horiz = F, cex = 0.6, box.lwd = 0)
```

In your report, write the statistical model that you used in mathematical 
notation. Be sure to define all your symbols and assumptions.

$$

$$

Interpolate the estimated trends to a grid, and plot them on a map. For the 
interpolations, you may consider using only the trend estimates whose standard 
errors are sufficiently small.

```{r}
high_se <- which(trends$se > 5)
low_len <- which(trends$len < 5)

# trends_sf <- sf::st_as_sf(x = trends, coords = c("LONGITUDE", "LATITUDE"), 
#                        crs = 4326, remove = TRUE)
# elev <- get_elev_point(trends_sf, src = "aws")
# trends$elevation <- elev$elevation

inter_trends <- trends[-c(high_se, low_len, hi_ak_sa),]



# i_t <- interpolation(trend ~ LONGITUDE + LATITUDE + elevation, 
#                      X_pred = elev.mat,
#                      data = inter_trends)
i_t <- interpolation(trend ~ LONGITUDE + LATITUDE, 
                     data = inter_trends)
plotting_interpolation(i_t, 
                       main = paste0("Estimated temperature trend in °C/year", 
                                     " across the \nUS contiguous 48"), 
                       palette = "Temps")
```


Find a reputable source for the average temperature trend in the contiguous USA 
over the past 20 years, and compare your results to the source’s.

\[https://www.ncei.noaa.gov/monitoring-content/temp-and-precip/us-trends/tavg/trends-tavg-ann-30year-full.gif]

